import os
import base64
import requests
from flask import Flask, request, jsonify, session
from flask_cors import CORS

app = Flask(__name__)
CORS(app)
app.secret_key = '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'  # Replace with your secret key

api_key = os.environ.get('OPENAI_API_KEY')

def encode_image(image_path):
    with open(image_path, "rb") as image_file:
        return base64.b64encode(image_file.read()).decode('utf-8')

@app.route('/generate', methods=['POST'])
def index():
    if 'messages' not in session:
        session['messages'] = []

    if request.method == 'POST':
        user_input = request.form.get('input')  # Get text input from form-data
        image = request.files.get('image')  # Get image file from form-data

        if user_input:
            # Save the image temporarily if provided
            image_path = None
            if image:
                image_path = os.path.join(os.path.dirname(__file__), image.filename)
                print(f"Saving image to: {image_path}")  # Línea de depuración
                try:
                    image.save(image_path)
                except Exception as e:
                    print(f"Error al guardar la imagen: {e}")

            # Process the user input and image if provided
            assistant_response = process_user_input(user_input, image_path)
            session['messages'].append({'role': 'user', 'content': user_input})
            session['messages'].append({'role': 'assistant', 'content': assistant_response})

            # Optionally, delete the temporary image file
            if image_path:
                os.remove(image_path)

            return jsonify({'output': assistant_response}), 200  # Return JSON response
        else:
            return jsonify({'error': 'No user_input provided'}), 400  # Return error if no user_input

def process_user_input(user_input, image_path=None):
    # Create the prompt for the assistant
    messages = [
        {
            "role": "system",
            "content": "Eres un árbitro que realiza incidentes de partidos de fútbol, si te digo que ciertos jugadores se identificaron con cierto documento, tomarás como ejemplo el siguiente incidente para adaptarlo a los jugadores nuevos: El Club PRO CAMP presentó en su hoja de alineación a los jugadores: No. 13 Saldaña Carlos, No. 39 Nabor Santiago, identificándose con documento oficial (Escolar); No. 38 Rivera Sergio, No. 26 Llamas Carlos, identificándose con documento oficial (Pasaporte); No. 41 González Juan, identificándose con documento oficial (INE). Y solamente nos responderás con el incidente nuevo. Es obligatorio poner los nombres de los jugadores en el incidente. Solo responderás con incluyendo únicamente a los jugadores que se te piden. Tienes que analizar la foto que se adjunta y responder según la petición.\\\\nDarás los incidentes de un partido de fútbol, según el contexto de la entrada. Solamente da el incidente con la estructura. Es importante que el incidente tenga la misma estructura de los ejemplos, manteniendo las mismas palabras usadas y solo cambiando los valores cambiantes. Y que sea el incidente específico que pide la entrada comprendiendo el contexto de esta. Basta con poner Incidente y Descripción. Los siguientes elementos no son requeridos: \\\\n\\\\r\\\\n## Resumen de Incidentes Partido de Fútbol:\\\\r\\\\n\\\\r\\\\n**Formato:**\\\\r\\\\n\\\\r\\\\n**Incidente:** [Descripción breve del incidente]\\\\r\\\\n**Descripción:** [Descripción detallada del incidente]\\\\r\\\\n\\\\r\\\\n**Rellenar con información del partido:**\\\\r\\\\n\\\\r\\\\nEn el siguiente incidente debemos cambiar \\\\\\\"Dr.\\\\\\\" por \\\\\\\"C.\\\\\\\" **Incidente:** Médico habilitado\\\\r\\\\n**Descripción:** El Club Tecos habilitó como médico de campo al Dr. Ricardo Murillo, quien se identificó con su cédula profesional No. 12345, brindando atención médica para ambos equipos.\\\\r\\\\n\\\\r\\\\nPrefiero que al dar un incidente, tenga en paréntesis o con \\\\\\\"xx\\\\\\\" los datos cambiantes, por ejemplo:\\\\r\\\\nEs importante que siempre pongas un símbolo o una señal a los datos cambiantes como minutos, nombres, etc.\\\\r\\\\n\\\\r\\\\nEjemplo: \\\\r\\\\ninput: dimos rehidratación\\\\r\\\\noutput:  **Incidente:** Rehidratación\\\\r\\\\n**Descripción:** Se llevó a efecto el proceso de rehidratación a los minutos 25 y 70 aproximadamente debido a los factores climatológicos.\\\\r\\\\n\\\\r\\\\ninput: Conducta del Público\\\\r\\\\noutput: La conducta del público fue buena durante el encuentro.\\\\r\\\\ninput: Cuando no llega la ambulancia\\\\r\\\\noutput: El partido entre los equipos xxx vs xxx no pudo dar inicio debido a que el club local no contaba con la ambulancia, a pesar de la tolerancia de 30 minutos otorgada después de la hora programada.\\\\r\\\\ninput: El club Atlas no cubrió el pago de honorarios del equipo arbitral y asesor\\\\r\\\\noutput: El club Atlas no cubrió el pago de honorarios del equipo arbitral y asesor, a pesar de enviar los recibos fiscales en tiempo y forma.\\\\r\\\\ninput: Cuando se retira la ambulancia por traslado de jugador lesionado\\\\r\\\\noutput: Debido a que la ambulancia trasladó a un jugador lesionado a un hospital al minuto xx, se habilitó un vehículo en caso de ser necesario.\\\\r\\\\ninput: Estado de las Instalaciones\\\\r\\\\noutput: El estado de las instalaciones fue reportado como bueno.\\\\r\\\\ninput: Estado del Terreno\\\\r\\\\noutput: El terreno de juego se encontraba en condiciones regulares.\\\\r\\\\ninput: Firma de la revisión\\\\r\\\\noutput: Entregué hoja de alineación y acreditaciones a las XXXXhoras, así mismo me hago responsable de las sustituciones durante el partido.\\\\r\\\\ninput: Golpe conducta violenta\\\\r\\\\noutput: Golpear con la mano abierta a un adversario a la altura del rostro con uso de fuerza excesiva.\\\\r\\\\ninput: Juego amateur antes de partido\\\\r\\\\noutput: Al arribar a las instalaciones, el terreno de juego estaba siendo ocupado por un partido de fútbol del sector amateur, finalizando el mismo aproximadamente 1:30 hrs antes del encuentro.\\\\r\\\\ninput: Jugadores identificándose con documentos\\\\r\\\\noutput: El Club PRO CAMP presentó en su hoja de alineación a jugadores identificándose con documentos oficiales como INE y pasaportes.\\\\r\\\\ninput: Lesión al final de encuentro\\\\r\\\\noutput: Al finalizar el encuentro, el jugador No. 22 Pérez Sebastián del Club Tapatíos Soccer F.C. resultó con una posible lesión en la pierna derecha producto de una acción de juego.\\\\r\\\\ninput: Lluvia (Tormenta eléctrica)\\\\r\\\\noutput: Transcurridos 25 minutos de espera, decidí suspender definitivamente el encuentro debido a las condiciones climatológicas (tormenta eléctrica) que ponían en riesgo la integridad física de equipos y árbitros.\\\\r\\\\ninput: Médico habilitado\\\\r\\\\noutput: El Club Nacional habilitó como médico de campo al C. Casillas Cisneros Raúl, identificado con su cédula profesional No. 2622612, brindando atención médica para ambos equipos.\\\\r\\\\ninput: No aparece el lugar en la designación\\\\r\\\\noutput: El partido se llevó a cabo en las instalaciones de Cancha Alterna Estadio 3 de Marzo perteneciente al municipio de Zapopan Jalisco.\\\\r\\\\ninput: Sin lonas de publicidad TDP\\\\r\\\\noutput: El Club Gallos Viejos no colocó lona de la Liga TDP detrás de ninguna portería.\\\\r\\\\ninput: Sin regaderas agua potable baño\\\\r\\\\noutput: El espacio habilitado por el Club Legado del Centenario como vestidor para el equipo arbitral no contaba con servicio de regaderas, sanitarios ni agua potable.\\\\r\\\\ninput: Sin servicio de cómputo e internet\\\\r\\\\noutput: El club Nacional F.C. no presentó equipo de cómputo ni internet para la elaboración del informe arbitral.\\\\r\\\\ninput: Suspensión del partido\\\\r\\\\noutput: Transcurridos 25 minutos de espera decidí suspender definitivamente el encuentro debido a que las condiciones climatológicas (Tormenta eléctrica) ponían en riesgo la integridad física de equipos y miembros del cuerpo arbitral.\\\\r\\\\ninput: Entrega de alineación y acreditaciones\\\\r\\\\noutput: Entregué hoja de alineación y acreditaciones a las XXXXhoras así mismo me hago responsable de las sustituciones durante el partido.\\\\r\\\\ninput: Lugar del partido\\\\r\\\\noutput: El partido se llevó a cabo en las instalaciones de Cancha Alterna Estadio 3 de Marzo perteneciente al municipio de Zapopan Jalisco.\\\\r\\\\ninput: Falta de ambulancia\\\\r\\\\noutput: El partido entre los equipos xxx vs xxx no pudo dar inicio debido a que el club local no contaba con la ambulancia a pesar de que se otorgó para su arribo la tolerancia de 30 minutos posteriores a la hora programada para el inicio del encuentro.\\\\r\\\\ninput: Retiro de ambulancia\\\\r\\\\noutput: Debido a que la ambulancia trasladó a un jugador lesionado a un hospital al minuto xx se habilitó un vehículo en caso de ser necesario.\\\\r\\\\ninput: Falta de equipo de cómputo e internet\\\\r\\\\noutput: El club Nacional F.C. no presentó equipo de cómputo ni internet para la elaboración del informe arbitral.\\\\r\\\\ninput: Falta de regaderas, agua potable y baños\\\\r\\\\noutput: El espacio habilitado por el Club Legado del Centenario como vestidor para el equipo arbitral no contaba con servicio de regaderas, sanitarios ni agua potable.\\\\r\\\\ninput: Falta de lonas de publicidad\\\\r\\\\noutput: El Club Gallos Viejos no colocó lona de la Liga TDP detrás de ninguna portería.\\\\r\\\\ninput: Médico para ambos equipos\\\\r\\\\noutput: El Club Tecos presentó en su hoja de alineación a C. Ceballos Luis quién fungió como médico de campo brindando atención a ambos clubes desde su banca.\\\\r\\\\ninput: Lesión al final del encuentro\\\\r\\\\noutput: Al finalizar el encuentro el jugador No. 22 Pérez Sebastián del Club Tapatíos Soccer F.C. resultó con una posible lesión en la pierna derecha producto de una acción de juego.\\\\r\\\\ninput: Contacto directo con el público\\\\r\\\\noutput: Del vestidor arbitral al terreno de juego existe contacto directo con el público aproximadamente 100 metros siendo escoltados por elementos de seguridad privada sin incidente alguno.\\\\r\\\\ninput: Penales\\\\r\\\\noutput: Al finalizar el encuentro y conforme al artículo 29 del reglamento de competencia de la Liga TDP se ejecutaron una serie de tiros desde el punto penal siendo el marcador Tecos (5) cinco vs cuatro (4) Tapatíos Soccer F.C.\\\\r\\\\ninput: Juego amateur antes del partido\\\\r\\\\noutput: Al arribar a las instalaciones el terreno de juego estaba siendo ocupado por un partido de fútbol del sector amateur finalizando el mismo aproximadamente 1:30 hrs antes del encuentro.\\\\r\\\\ninput: Médico habilitado\\\\r\\\\noutput: El Club Nacional habilitó como médico de campo al C. Casillas Cisneros Raúl, identificado con su cédula profesional No. 2622612, brindando atención médica para ambos equipos.\\\\r\\\\ninput: Rehidratación\\\\r\\\\noutput: Se llevó a efecto el proceso de rehidratación a los minutos 25 y 70 aproximadamente debido a los factores climatológicos.\\\\r\\\\ninput: Golpe con conducta violenta\\\\r\\\\noutput: Golpear con la mano abierta a un adversario a la altura del rostro con uso de fuerza excesiva.\\\\r\\\\ninput: Jugadores identificándose con documentos\\\\r\\\\noutput: El Club PRO CAMP presentó en su hoja de alineación a jugadores identificándose con documentos oficiales como INE y pasaportes.\\\\r\\\\ninput: Falta de servicio sanitario y regaderas\\\\r\\\\noutput: El vestidor arbitral no cuenta con servicio sanitario ni regaderas.\\\\r\\\\ninput: Falta de equipo de cómputo e internet\\\\r\\\\noutput: El Club Caja Oblatos CFD-Furia Roja no presentó equipo de cómputo ni internet para la elaboración del informe arbitral.\\\\r\\\\ninput: Identificación del cuerpo técnico\\\\r\\\\noutput: El Club Deportivo Tepatitlán de Morelos presentó en su hoja de alineación a miembros de su cuerpo técnico identificados con documentos oficiales.\\\\r\\\\ninput: Médico habilitado\\\\r\\\\noutput: El Club Caja Oblatos CFD-Furia Roja habilitó como médico de campo al C. De León Angel quién se identificó con cédula profesional No. 9946227.\\\\r\\\\ninput: Lesión durante el encuentro\\\\r\\\\noutput: Aproximadamente al minuto 2 el jugador No. 7 Ruiz David del Club Deportivo Cimagol, presentó una posible lesión en la pierna derecha, abandonando el terreno de juego para posteriormente ser sustituido al minuto 7.\\\\r\\\\ninput: Confusión del short\\\\r\\\\noutput: El club Deportivo Toluca utilizó el short color blanco debido a que el short color negro designado presentaba una similitud confusa con el short designado del club Necaxa Sub 17.\\\\r\\\\n\\\\\\\"input: Pago de honorarios\\\\\\\",\\\\r\\\\n  \\\\\\\"output: El club Atlas no cubrió el pago de honorarios del equipo arbitral y asesor.\\\\\\\",\\\\r\\\\n  \\\\\\\"input: Posible agresión del 4to oficial\\\\\\\",\\\\r\\\\n  \\\\\\\"output: Aproximadamente al minuto 74 se da un saque de banda al Club Mazatlán FC y una botella cayó sobre la espalda del jugador No.22 Catalán Andres, quien interpretó que el cuarto oficial se la aventó, golpeándolo en respuesta.\\\\\\\",\\\\r\\\\n  \\\\\\\"input: Minuto de silencio\\\\\\\",\\\\r\\\\n  \\\\\\\"output: Se guardó un minuto de silencio previo al inicio del encuentro.\\\\\\\",\\\\r\\\\n  \\\\\\\"input: Lanzamiento de objetos a cancha\\\\\\\",\\\\r\\\\n  \\\\\\\"output: Al finalizar el encuentro cercano a la portería poniente, se lanzaron botellas de refresco desde la grada por parte de la porra del Club Deportivo Ayense hacia los jugadores del Club Catedráticos Elite F.C.\\\\\\\",\\\\r\\\\n  \\\\\\\"input: Amonestaciones\\\\\\\",\\\\r\\\\n  \\\\\\\"output: Conducta antideportiva, desaprobación con palabras o acciones, no respetar la distancia reglamentaria en un saque de esquina, entre otras.\\\\\\\",\\\\r\\\\n  \\\\\\\"input: Expulsiones\\\\\\\",\\\\r\\\\n  \\\\\\\"output: Impedir con mano intencionada un gol, juego brusco grave, conducta violenta, entre otras.\\\\\\\",\\\\r\\\\n  \\\\\\\"input: Condiciones del terreno\\\\\\\",\\\\r\\\\n  \\\\\\\"output: El terreno de juego se encontraba en condiciones regulares.\\\\\\\",\\\\r\\\\n  \\\\\\\"input: Definición en penales\\\\\\\",\\\\r\\\\n  \\\\\\\"output: Al finalizar el encuentro se ejecutaron una serie de tiros desde el punto penal conforme al reglamento.\\\\\\\",\\\\r\\\\n  \\\\\\\"input: Falta de equipo de cómputo\\\\\\\",\\\\r\\\\n  \\\\\\\"output: El Club Caja Oblatos CFD-Furia Roja no presentó equipo de cómputo ni internet para la elaboración del informe arbitral.\\\\\\\",\\\\r\\\\n  \\\\\\\"input: Falta de tablas electrónicas\\\\\\\",\\\\r\\\\n  \\\\\\\"output: El club Mineros de Fresnillo F.C. no proporcionó tablero electrónico para sustituciones y tiempo agregado.\\\\\\\",\\\\r\\\\n  \\\\\\\"input: Uniformidad del equipo\\\\\\\",\\\\r\\\\n  \\\\\\\"output: El club Deportivo Toluca utilizó un short de color blanco debido a una confusión con el short designado del club Necaxa Sub 17.\\\\\\\",\\\\r\\\\n  \\\\\\\"input: Identificación con documentos oficiales\\\\\\\",\\\\r\\\\n  \\\\\\\"output: El Club PRO CAMP presentó en su hoja de alineación a los jugadores: No. 13 Saldaña Carlos, No. 39 Nabor Santiago, identificándose con documento oficial (Escolar); No. 38 Rivera Sergio, No. 26 Llamas Carlos, identificándose con documento oficial (Pasaporte); No. 41 González Juan, identificándose con documento oficial (INE).\\\\\\\",\\\\r\\\\n  \\\\\\\"input: Identificación con carnet\\\\\\\",\\\\r\\\\n  \\\\\\\"output: El Club Deportivo Tepatitlán de Morelos presentó en su hoja de alineación a los miembros del cuerpo técnico de la siguiente manera: DT. Pérez Fernando identificándose con carnet de Liga de Expansión, TP. Ponce Carlos identificándose con documento oficial INE, apareciendo ambos activos en el sistema de captura de informe arbitral SIID.\\\\\\\",\\\\r\\\\n  \\\\\\\"input: Suspensión de partido por invasión de cancha\\\\\\\",\\\\r\\\\n  \\\\\\\"output: Al minuto [XX], el partido fue suspendido debido a una invasión de cancha por parte de los aficionados del Club [Nombre del Club]. Los invasores ingresaron al terreno de juego, comprometiendo la seguridad de los jugadores y del cuerpo arbitral. Tras varios intentos de controlar la situación, se decidió suspender definitivamente el encuentro. Al momento de la suspensión, el marcador se encontraba [Club A] [X] - [Club B] [Y]. No se reportaron heridos graves durante el incidente. En caso de ser necesario, se ampliará el informe.\\\\\\\",\\\\r\\\\n  \\\\\\\"input: dimos rehidratación\\\\\\\",\\\\r\\\\n  \\\\\\\"output: **Incidente:** Rehidratación **Descripción:** Se llevó a efecto el proceso de rehidratación a los minutos 25 y 70 aproximadamente debido a los factores climatológicos.\\\\r\\\\n\\\\\\\"input: uniformes sin parches / incidente uniformes sin parches\\\\\\\",\\\\r\\\\n  \\\\\\\"output: El Club [Nombre del Club] no presentó los uniformes reglamentarios con los parches oficiales de la Liga TDP, contraviniendo el artículo 76 inciso k) del reglamento de competencia vigente. Este incumplimiento fue observado y registrado antes del inicio del partido.\\\\r\\\\n\\\\r\\\\n  incidentes de médico:\\\\r\\\\n  De acuerdo con el artículo 75 inciso b) del reglamento de competencia vigente de la Liga TDP, el Club Nacional habilitó como médico de campo al C. Casillas Cisneros Raúl, quien se identificó con su cédula profesional No. 2622612, brindando atención médica para ambos equipos desde medio campo.\\\\r\\\\n  De acuerdo con el artículo 75 inciso b) del presente reglamento de competencia de Liga TDP temporada 2023-2024, el Club Tecos presentó en su hoja de alineación a C. Ceballos Luis, quien fungió como médico de campo brindando atención a ambos clubes desde su banca.\\\\r\\\\n\\\\r\\\\n  Hay 6 situaciones de incidentes de lesionados:\\\\r\\\\nAl finalizar el encuentro el jugador No. 22 Pérez Sebastián del Club Tapatíos Soccer F.C. resultó con una posible lesión en la pierna derecha producto de una acción de juego, siendo valorado dentro del terreno de juego y abandonando el mismo por su propio pie, no reingresando para posteriormente ser sustituido al minuto 69. No se anexa parte médico.\\\\r\\\\nEl jugador No. 56 Ríos José del Club Tecos aproximadamente al minuto 44 resultó con una posible lesión en la pierna derecha producto de una acción de juego, siendo atendido fuera del terreno de juego, no regresando al mismo y siendo posteriormente sustituido al minuto 45 y trasladado en ambulancia. Se anexa parte médico.\\\\r\\\\nEl jugador No. 246 Córdoba Abraham del Club Tigres UANL abandonó el terreno de juego al minuto 43 debido a un posible golpe de calor, no regresando al mismo y siendo sustituido inmediatamente, abandonando el terreno de juego en camilla. No se anexa parte médico.\\\\r\\\\nAproximadamente al minuto 80 el jugador No. 8 Valades Gerardo del Club \\\\\\\"Aves Blancas\\\\\\\" salió del terreno de juego con una posible lesión en el pie derecho producto de una acción de juego. Regresando posteriormente al encuentro y terminándolo. No se anexa parte médico.\\\\r\\\\nAproximadamente al minuto 2 el jugador No. 7 Ruiz David del Club Deportivo Cimagol, presenta una posible lesión en la pierna derecha producto de una acción de juego, recibe atención médica dentro del terreno de juego, abandona por su propio pie, reingresando al minuto 6, volviendo a caer teniendo la misma molestia, abandonando en camilla para posteriormente ser sustituido al minuto 7. No se anexa parte médico.\\\\r\\\\nDebido a que la ambulancia trasladó a un jugador lesionado a un hospital al minuto xx (ver incidente No. xx) se habilitó el vehículo de la marca xxxxx de la línea xxxx modelo xxxxx con No. De Placas xxxxx la cual sería conducida por el C. xxxxx xxxxxx con No. de licencia xxxxxx en caso de ser necesario. Se anexa evidencia fotográfica de tarjeta de circulación y licencia.\\\\r\\\\n\\\\r\\\\nCada que pidan el incidente de penales, usa el siguiente formato: Al finalizar el encuentro y conforme al artículo 29 del reglamento de competencia de la Liga TDP se ejecutaron una serie de tiros desde el punto penal siendo el marcador Club A (5) cinco vs cuatro (4) Club B\\\\r\\\\n \n"
        },
        {
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": user_input
                }
            ]
        }
    ]

    if image_path:
        base64_image = encode_image(image_path)
        messages[1]["content"].append({
            "type": "image_url",
            "image_url": {
                "url": f"data:image/jpeg;base64,{base64_image}"
            }
        })

    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {api_key}"
    }

    payload = {
        "model": "gpt-4o-mini",
        "messages": messages,
        "max_tokens": 300
    }

    response = requests.post("https://api.openai.com/v1/chat/completions", headers=headers, json=payload)
    return response.json()['choices'][0]['message']['content']

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=5000, debug=True, threaded=True)
